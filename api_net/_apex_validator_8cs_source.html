<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Pyramid Technologies .NET RS-232 API: C:/_refFirmwares/Pyramid-CSharp-API-Source/Apex7000_BillValidator/ApexValidator.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="api_thumb_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Pyramid Technologies .NET RS-232 API
   &#160;<span id="projectnumber">1.0.0.0</span>
   </div>
   <div id="projectbrief">RS-232 Bill Acceptor API for Pyramid Bill Validators</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_apex_validator_8cs_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ApexValidator.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">using</span> <a class="code" href="namespacelog4net.html">log4net</a>;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_p_t_i.html">PTI</a>.<a class="code" href="namespace_p_t_i_1_1_serial.html">Serial</a>;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Collections.Generic;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.IO;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Threading;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno"><a class="line" href="namespace_apex7000___bill_validator.html">    8</a></span>&#160;<span class="keyword">namespace </span><a class="code" href="namespace_apex7000___bill_validator.html">Apex7000_BillValidator</a></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;{</div>
<div class="line"><a name="l00014"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html">   14</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">partial class </span><a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html">ApexValidator</a> : IDisposable</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    {</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;      </div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        <span class="keyword">private</span> readonly <span class="keywordtype">object</span> mutex = <span class="keyword">new</span> object();</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        <span class="keyword">private</span> <span class="keyword">static</span> readonly ILog log = LogManager.GetLogger(<a class="code" href="namespace_system.html">System</a>.Reflection.MethodBase.GetCurrentMethod().DeclaringType);</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">        #region Fields</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        <span class="keyword">private</span> StrongPort port = null;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        <span class="keyword">private</span> <a class="code" href="class_apex7000___bill_validator_1_1_r_s232_config.html">RS232Config</a> config;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        <span class="keyword">private</span> <span class="keywordtype">bool</span> resetRequested = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">        #endregion</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">        #region Internal State</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        <span class="comment">// State variables for tracking between events and states</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        <span class="keyword">private</span> byte Ack { <span class="keyword">get</span>; set; }</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        <span class="comment">// Track if we have already reported the cashbox state. We always</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        <span class="comment">// raise the cashbox missing event but report cashbox attached event</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        <span class="comment">// only once.</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        <span class="keyword">private</span> <span class="keywordtype">bool</span> CashboxPresent { <span class="keyword">get</span>; set; }</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        <span class="comment">// If true, the slave is reporting that a note is in escrow</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        <span class="keyword">private</span> <span class="keywordtype">bool</span> NoteIsEscrowed { <span class="keyword">get</span>; set; }</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;        <span class="comment">// Last reported credit from slave</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        <span class="keyword">private</span> byte Credit { <span class="keyword">get</span>; set; }</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        <span class="comment">// Additional feature: async flag to tell the slave</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        <span class="comment">// to ACCEPT or REJECT the note next time the master polls</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        <span class="keyword">private</span> EscrowCommands EscrowCommand { <span class="keyword">get</span>; set; }</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        <span class="comment">// Used in case we need to retransmit</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        <span class="keyword">private</span> byte[] previouslySentMasterMsg { <span class="keyword">get</span>; set; }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        <span class="comment">// Time at which escrow starts</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        <span class="keyword">private</span> DateTime escrowStart = DateTime.MinValue;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html#a1e80bfa86918dda40e30cd4d321be435">   55</a></span>&#160;        <span class="keyword">public</span> <a class="code" href="namespace_apex7000___bill_validator.html#a54e769340ad9f0d9d62901309f5b1a8d">States</a> <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a1e80bfa86918dda40e30cd4d321be435">PreviousState</a> { <span class="keyword">get</span>; <span class="keyword">private</span> set; }</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html#a81784448a351130d74964d5c86388c86">   60</a></span>&#160;        <span class="keyword">public</span> <a class="code" href="namespace_apex7000___bill_validator.html#ae1f75780a1fc91508f59eb21caec7dbc">Events</a> <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a81784448a351130d74964d5c86388c86">PreviousEvents</a> { <span class="keyword">get</span>; <span class="keyword">private</span> set; }</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html#aca555eba93a2c358b7d81368b32a3d8b">   65</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#aca555eba93a2c358b7d81368b32a3d8b">IsRunning</a> { <span class="keyword">get</span>; <span class="keyword">private</span> set; }</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="preprocessor">        #endregion</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html#a0e3003b4ad602a0ab34aa728aa1f9de7">   72</a></span>&#160;        <span class="keyword">public</span> <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a0e3003b4ad602a0ab34aa728aa1f9de7">ApexValidator</a>(<a class="code" href="class_apex7000___bill_validator_1_1_r_s232_config.html">RS232Config</a> config)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        {</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;            this.config = config;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        }</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html#a71d876ee0f6ca1c8317a119ec65bc5ea">   82</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> List&lt;string&gt; <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a71d876ee0f6ca1c8317a119ec65bc5ea">GetAvailablePorts</a>()</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        {</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            <span class="keywordflow">return</span> StrongPort.GetAvailablePorts();</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        }</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html#ae3985a0217ac9eb3aaabb56294f51b45">   91</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#ae3985a0217ac9eb3aaabb56294f51b45">Close</a>()</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        {</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            <span class="comment">// This will kill the comms loop</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#aca555eba93a2c358b7d81368b32a3d8b">IsRunning</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            <span class="keywordflow">if</span>(port != null)</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                port.Disconnect();</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        }</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html#a2a361f835b0e31f584046ec4eb1e85e6">  105</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a2a361f835b0e31f584046ec4eb1e85e6">Connect</a>()</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        {</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            <span class="comment">// Lock so we only have one connection attempt at a time. This protects</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            <span class="comment">// from client code behaving badly.</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            lock (mutex)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                <span class="keywordflow">try</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                    port = <span class="keyword">new</span> StrongPort(config.<a class="code" href="class_apex7000___bill_validator_1_1_r_s232_config.html#ade91589fc9f5da76f38cf47259889074">CommPortName</a>);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                <span class="keywordflow">catch</span> (IOException)</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                {</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                    NotifyError(<a class="code" href="namespace_apex7000___bill_validator.html#ae2e346222c94e598b19864435d07b18e">Errors</a>.FailedToOpenPort);</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                }</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                port.ReadTimeout = 500;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                <a class="code" href="class_apex7000___bill_validator_1_1_debug_buffer_entry.html">DebugBufferEntry</a>.SetEpoch();</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                <span class="keywordflow">try</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                    port.Connect();</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                    <span class="comment">// Only start if we connect without error</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                    startRS232Loop();</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                }</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                <span class="keywordflow">catch</span> (Exception e)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                {</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                    log.ErrorFormat(<span class="stringliteral">&quot;Exception Connecting to acceptor: {0}&quot;</span>, e.Message, e);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a90b1a6032cffe4a13db99f27387b89e8">OnError</a> != null)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                    {</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                        NotifyError(<a class="code" href="namespace_apex7000___bill_validator.html#ae2e346222c94e598b19864435d07b18e">Errors</a>.PortError);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                    }</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            }         </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        }</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno"><a class="line" href="class_apex7000___bill_validator_1_1_apex_validator.html#abf1ccb34c3402102da76f9410e0215db">  159</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#abf1ccb34c3402102da76f9410e0215db">RequestReset</a>()</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        {</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            resetRequested = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        }</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="keyword">private</span> <span class="keywordtype">void</span> Reconnect()</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            <span class="comment">// Try to close the port before we re instantiate. If this</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;            <span class="comment">// explodes there are bigger issues</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            port.Disconnect();</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <span class="comment">// Let the port cool off (close base stream, etc.)</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            Thread.Sleep(100);</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a2a361f835b0e31f584046ec4eb1e85e6">Connect</a>();</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        }</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keyword">private</span> <span class="keywordtype">void</span> startRS232Loop()</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#aca555eba93a2c358b7d81368b32a3d8b">IsRunning</a>)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;            {</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                log.Error(<span class="stringliteral">&quot;Already running RS-232 Comm loop... Exiting now...&quot;</span>);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;            }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            <span class="comment">// Polls the slave using the interval defined in config.PollRate (milliseconds)</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            Thread speakThread = <span class="keyword">new</span> Thread((fn) =&gt;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#aca555eba93a2c358b7d81368b32a3d8b">IsRunning</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                <span class="comment">// Set toggle flag so we can kill this loop</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                <span class="keywordflow">while</span> (<a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#aca555eba93a2c358b7d81368b32a3d8b">IsRunning</a>)</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                {</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                    <span class="keywordflow">if</span> (resetRequested)</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                        DoResetAcceptor();</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                        speakToSlave();                  </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                    Thread.Sleep(config.<a class="code" href="class_apex7000___bill_validator_1_1_r_s232_config.html#a55d7f2d6ece5f5382379592b38532ac8">PollRate</a>);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                }</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            });</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;            speakThread.IsBackground = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            speakThread.Start();</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        }</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="preprocessor">        #region Implementation</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keyword">private</span> <span class="keywordtype">void</span> speakToSlave()</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        {</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;            byte[] data;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            <span class="keywordflow">if</span> (previouslySentMasterMsg == null)</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            {</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                data = GenerateNormalMessage();</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;            }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;            {</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                data = previouslySentMasterMsg;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            }</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;           </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="comment">// Attempt to write data to slave            </span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            NotifySerialData(DebugBufferEntry.AsMaster(data));</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;            WriteWrapper(data);</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            <span class="comment">// Blocks until all 11 bytes are read or we give up</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            var resp = ReadWrapper();</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            <span class="comment">// Extract only the states and events</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            NotifySerialData(DebugBufferEntry.AsSlave(resp));</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;            <span class="comment">// No data was read, return!!</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            <span class="keywordflow">if</span> (resp.Length == 0)</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            {</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                <span class="comment">// Do no toggle the ack</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            }</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            <span class="comment">// Check that we have the same ACK #</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsBadAckNumber(resp, data))</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            {</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                previouslySentMasterMsg = data;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            }</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            <span class="comment">// TODO check response checksum</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            <span class="comment">// Otherwise we&#39;re all good - toggle ack and clear last sent message</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                previouslySentMasterMsg = null;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                Ack ^= 1;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;            }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;            </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            <span class="comment">// At this point we have sent our message and received a valid response.</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;            <span class="comment">// Parse the response and act on any state or events that are reported.</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            <span class="comment">// Translate raw bytes into friendly enums</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            var slaveMessage = SlaveCodex.ToSlaveMessage(resp);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a1e80bfa86918dda40e30cd4d321be435">PreviousState</a> = SlaveCodex.GetState(slaveMessage);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            <span class="comment">// Raise a state changed notice for clients</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            NotifyStateChange(<a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a1e80bfa86918dda40e30cd4d321be435">PreviousState</a>);</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;           </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            <span class="comment">// Multiple event may be reported at once</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            var currentEvents = SlaveCodex.GetEvents(slaveMessage);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;            <span class="keywordflow">foreach</span> (<a class="code" href="namespace_apex7000___bill_validator.html#ae1f75780a1fc91508f59eb21caec7dbc">Events</a> e <span class="keywordflow">in</span> Enum.GetValues(typeof(<a class="code" href="namespace_apex7000___bill_validator.html#ae1f75780a1fc91508f59eb21caec7dbc">Events</a>)))</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            {</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                <span class="comment">// If flag is set in slave message, report event</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                <span class="keywordflow">if</span>((currentEvents &amp; e) == e)</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                    NotifyEvent(e);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            }</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            <span class="comment">// Check for cassette missing - reports every time cashbox is missing</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            <span class="keywordflow">if</span> (!SlaveCodex.IsCashboxPresent(slaveMessage))</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            {</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                CashboxPresent = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                NotifyError(<a class="code" href="namespace_apex7000___bill_validator.html#ae2e346222c94e598b19864435d07b18e">Errors</a>.CashboxMissing);</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            }</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;            <span class="comment">// Only report the cashbox attached 1 time after it is re-attached</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!CashboxPresent)</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            {</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                CashboxPresent = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                SafeEvent(<a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#ae0f9dcdc5f6afd79e20b19828934c267">OnCashboxAttached</a>);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            }</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            <span class="comment">// Mask away rest of message to see if a note is in escrow. If this is the first</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            <span class="comment">// escrow message, start the escrow timeout clock</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            <span class="keywordflow">if</span>(!NoteIsEscrowed &amp;&amp; <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a1e80bfa86918dda40e30cd4d321be435">PreviousState</a> == <a class="code" href="namespace_apex7000___bill_validator.html#a54e769340ad9f0d9d62901309f5b1a8d">States</a>.Escrowed)</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            {</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                escrowStart = DateTime.MinValue;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            }</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            NoteIsEscrowed = (<a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a1e80bfa86918dda40e30cd4d321be435">PreviousState</a> == <a class="code" href="namespace_apex7000___bill_validator.html#a54e769340ad9f0d9d62901309f5b1a8d">States</a>.Escrowed);</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            <span class="comment">// Credit bits are 3-5 of data byte 3 </span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            var value = SlaveCodex.GetCredit(slaveMessage);</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            <span class="keywordflow">if</span> (value &gt; 0)</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            {</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                Credit = (byte)value;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            }</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            <span class="comment">// Per the spec, credit message is issued by master after stack event is </span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            <span class="comment">// sent by the slave. If the previous event was stacked or returned, we</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            <span class="comment">// must clear the escrow command to completely release the note from</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            <span class="comment">// escrow state.</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;            <span class="keywordflow">switch</span>(<a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a81784448a351130d74964d5c86388c86">PreviousEvents</a>)</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            {</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="namespace_apex7000___bill_validator.html#ae1f75780a1fc91508f59eb21caec7dbc">Events</a>.Stacked:</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                    NotifyCredit(Credit);</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                    <span class="comment">// C# does not allow fallthrough so we will goto :)</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                    <span class="keywordflow">goto</span> <span class="keywordflow">case</span> <a class="code" href="namespace_apex7000___bill_validator.html#ae1f75780a1fc91508f59eb21caec7dbc">Events</a>.Returned;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    </div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="namespace_apex7000___bill_validator.html#ae1f75780a1fc91508f59eb21caec7dbc">Events</a>.Returned:                                </div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                    <span class="comment">// Clear our the pending escrow command once we&#39;ve stacked or returned the note</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                    EscrowCommand = EscrowCommands.None;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                    Credit = 0;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            }</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;            <span class="comment">// Update the events aster the check for check so as to not lose a credit message</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;            <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a81784448a351130d74964d5c86388c86">PreviousEvents</a> = currentEvents;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                       </div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        }</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="preprocessor">        #region GenerateMsg Write Read Checksum</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="keyword">private</span> byte[] GenerateNormalMessage()</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        {</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;            <span class="comment">//     # basic message   0      1      2      3      4      5    6      7</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;            <span class="comment">//                      start, len,  ack, bills,escrow,resv&#39;d,end, checksum</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            var data = Request.BaseMessage;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            <span class="comment">// Toggle message number (ack #) if last message was okay and not a re-send request.</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            data[2] = (byte)(0x10 | Ack);</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            <span class="keywordflow">if</span>(!config.<a class="code" href="class_apex7000___bill_validator_1_1_r_s232_config.html#a9754bded053ecdce67bcd8c58bfd79c4">IsEscrowMode</a>)</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            {</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                <span class="comment">// Not escrow mode, all notes are enabled by default</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                data[3] = 0x7F;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                <span class="comment">// Clear escrow mode bit</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                data[4] = 0x00;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                <span class="keywordflow">if</span> (NoteIsEscrowed)</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                    data[4] |= 0x20;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            } </div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            {</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                <span class="comment">// Get enable mask from client configuration. On next message, the acceptor</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                <span class="comment">// will update itself and not escrow any notes that are disabled in this mask.</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                data[3] = config.<a class="code" href="class_apex7000___bill_validator_1_1_r_s232_config.html#ab938083d745d9ef0d31cb8ac653c7793">EnableMask</a>;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                <span class="comment">// Set escrow mode bit</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                data[4] = 1 &lt;&lt; 4;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                <span class="keywordflow">if</span>(NoteIsEscrowed)</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                {</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                    <span class="comment">// Perform timeout check and set reject flag is timeout exceeded</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                    <span class="keywordflow">if</span>(config.<a class="code" href="class_apex7000___bill_validator_1_1_r_s232_config.html#af292d4b34464a2e651f4268c8a11181b">EscrowTimeoutSeconds</a> &gt; 0)</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                    {</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                        <span class="keywordflow">if</span>(escrowStart == DateTime.MinValue)</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                        {</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                            escrowStart = DateTime.Now;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                        }</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                        var delta = DateTime.Now - escrowStart;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                        <span class="keywordflow">if</span> (delta.TotalSeconds &gt; config.<a class="code" href="class_apex7000___bill_validator_1_1_r_s232_config.html#af292d4b34464a2e651f4268c8a11181b">EscrowTimeoutSeconds</a>)</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                        {</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                            EscrowCommand = EscrowCommands.Reject;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                            </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                            escrowStart = DateTime.MinValue;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                        }</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                    }</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                    <span class="comment">// Otherwise do what the host tells us to do.</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                    <span class="keywordflow">switch</span> (EscrowCommand)</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                    {</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                        <span class="keywordflow">case</span> EscrowCommands.Stack:</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                            <span class="comment">// set stack bit</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                            data[4] |= 0x20;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                            EscrowCommand = EscrowCommands.None;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                        <span class="keywordflow">case</span> EscrowCommands.Reject:</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                            <span class="comment">// set reject bit</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                            data[4] |= 0x40;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                            EscrowCommand = EscrowCommands.None;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                        <span class="keywordflow">case</span> EscrowCommands.None:</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                            NotifyEscrow(Credit);</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                    }</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                }</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            }</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            <span class="comment">// Set the checksum</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            <span class="keywordflow">return</span> Checksum(data);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        }</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <span class="keyword">private</span> <span class="keywordtype">void</span> WriteWrapper(byte[] data)</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        {</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            <span class="keywordflow">try</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            {</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                port.Write(data);</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            }</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            <span class="keywordflow">catch</span> (PortException pe)</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            {</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                <span class="keywordflow">switch</span> (pe.ErrorType)</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                {</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                    <span class="keywordflow">case</span> ExceptionTypes.WriteError:</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                        NotifyError(<a class="code" href="namespace_apex7000___bill_validator.html#ae2e346222c94e598b19864435d07b18e">Errors</a>.WriteError);</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                    <span class="keywordflow">case</span> ExceptionTypes.PortError:</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                        NotifyError(<a class="code" href="namespace_apex7000___bill_validator.html#ae2e346222c94e598b19864435d07b18e">Errors</a>.PortError);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                        <span class="keywordflow">throw</span> pe.GetBaseException();</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                }</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;            }</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        }</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="keyword">private</span> byte[] ReadWrapper()</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        {</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            <span class="keywordflow">try</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            {</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                <span class="keywordflow">return</span> port.Read();</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            }</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            <span class="keywordflow">catch</span> (PortException pe)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            {</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                <span class="keywordflow">switch</span> (pe.ErrorType)</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                {</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                    <span class="keywordflow">case</span> ExceptionTypes.Timeout:</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                        NotifyError(<a class="code" href="namespace_apex7000___bill_validator.html#ae2e346222c94e598b19864435d07b18e">Errors</a>.Timeout);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                        <span class="keywordflow">throw</span> pe.GetBaseException();</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                }</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">new</span> byte[0];</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            }</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        }</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        <span class="keyword">private</span> <span class="keywordtype">void</span> DoResetAcceptor()</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        {</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;            byte[] reset = Request.ResetTarget;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;            <span class="comment">// Toggle message number (ack #) if last message was okay and not a re-send request.</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            reset[2] = (byte)(0x10 | Ack);</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            Checksum(reset);</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            WriteWrapper(reset);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;            <span class="comment">// Toggle ACK number</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;            Ack ^= 1;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;            resetRequested = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        }</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="keyword">private</span> byte[] Checksum(byte[] msg)</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        {</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;            List&lt;byte&gt; tmp = <span class="keyword">new</span> List&lt;byte&gt;(msg);</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            byte checksum = (byte)(msg[1] ^ msg[2]);</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 3; i &lt; msg.Length - 1; i++)</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;            {</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                checksum ^= msg[i];</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;            }</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            tmp.Add(checksum);</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;            <span class="keywordflow">return</span> tmp.ToArray();</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        }</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> IsBadAckNumber(byte[] resp, byte[] data)</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        {</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            <span class="keywordflow">return</span> (resp[2] &amp; 1) != (data[2] &amp; 1);</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        }</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="preprocessor">        #endregion</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="preprocessor">        #endregion</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="preprocessor">        #region IDisposable</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_apex7000___bill_validator_1_1_apex_validator.html#a2c1a26258776593c7b6a4833aba4ee9d">Dispose</a>()</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        {</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            <span class="keywordflow">if</span> (port != null)</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                port.Dispose();</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        }</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="preprocessor">        #endregion</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    }</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;}</div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_aca555eba93a2c358b7d81368b32a3d8b"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#aca555eba93a2c358b7d81368b32a3d8b">Apex7000_BillValidator.ApexValidator.IsRunning</a></div><div class="ttdeci">bool IsRunning</div><div class="ttdoc">Returns true if the communication thread is running normally </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00065">ApexValidator.cs:65</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_a1e80bfa86918dda40e30cd4d321be435"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#a1e80bfa86918dda40e30cd4d321be435">Apex7000_BillValidator.ApexValidator.PreviousState</a></div><div class="ttdeci">States PreviousState</div><div class="ttdoc">Slave&#39;s last state </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00055">ApexValidator.cs:55</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_r_s232_config_html_af292d4b34464a2e651f4268c8a11181b"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_r_s232_config.html#af292d4b34464a2e651f4268c8a11181b">Apex7000_BillValidator.RS232Config.EscrowTimeoutSeconds</a></div><div class="ttdeci">int EscrowTimeoutSeconds</div><div class="ttdoc">Gets or sets the timeout for escrow mode. By default, we wait indefinately but you may configure this...</div><div class="ttdef"><b>Definition:</b> <a href="_r_s232_config_8cs_source.html#l00089">RS232Config.cs:89</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_r_s232_config_html_ade91589fc9f5da76f38cf47259889074"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_r_s232_config.html#ade91589fc9f5da76f38cf47259889074">Apex7000_BillValidator.RS232Config.CommPortName</a></div><div class="ttdeci">string CommPortName</div><div class="ttdoc">String name of the comm port (What the OS calls it) </div><div class="ttdef"><b>Definition:</b> <a href="_r_s232_config_8cs_source.html#l00074">RS232Config.cs:74</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_ae3985a0217ac9eb3aaabb56294f51b45"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#ae3985a0217ac9eb3aaabb56294f51b45">Apex7000_BillValidator.ApexValidator.Close</a></div><div class="ttdeci">void Close()</div><div class="ttdoc">Stop talking to the slave and release the underlying commm port. </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00091">ApexValidator.cs:91</a></div></div>
<div class="ttc" id="namespace_apex7000___bill_validator_html_ae1f75780a1fc91508f59eb21caec7dbc"><div class="ttname"><a href="namespace_apex7000___bill_validator.html#ae1f75780a1fc91508f59eb21caec7dbc">Apex7000_BillValidator.Events</a></div><div class="ttdeci">Events</div><div class="ttdoc">Slave acceptor may report a single-shot "Event" taking place. Multiple events may be reported in a si...</div><div class="ttdef"><b>Definition:</b> <a href="_data_contracts_8cs_source.html#l00079">DataContracts.cs:79</a></div></div>
<div class="ttc" id="namespace_apex7000___bill_validator_html_ae2e346222c94e598b19864435d07b18e"><div class="ttname"><a href="namespace_apex7000___bill_validator.html#ae2e346222c94e598b19864435d07b18e">Apex7000_BillValidator.Errors</a></div><div class="ttdeci">Errors</div><div class="ttdoc">Errors reported by this library </div><div class="ttdef"><b>Definition:</b> <a href="_data_contracts_8cs_source.html#l00125">DataContracts.cs:125</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_a2c1a26258776593c7b6a4833aba4ee9d"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#a2c1a26258776593c7b6a4833aba4ee9d">Apex7000_BillValidator.ApexValidator.Dispose</a></div><div class="ttdeci">void Dispose()</div><div class="ttdoc">Releases comm port and related managed resources. </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00554">ApexValidator.cs:554</a></div></div>
<div class="ttc" id="namespace_system_html"><div class="ttname"><a href="namespace_system.html">System</a></div></div>
<div class="ttc" id="namespace_apex7000___bill_validator_html_a54e769340ad9f0d9d62901309f5b1a8d"><div class="ttname"><a href="namespace_apex7000___bill_validator.html#a54e769340ad9f0d9d62901309f5b1a8d">Apex7000_BillValidator.States</a></div><div class="ttdeci">States</div><div class="ttdoc">The bill acceptor will pass through a series of "States" during bill processing. The acceptor will al...</div><div class="ttdef"><b>Definition:</b> <a href="_data_contracts_8cs_source.html#l00010">DataContracts.cs:10</a></div></div>
<div class="ttc" id="namespace_p_t_i_html"><div class="ttname"><a href="namespace_p_t_i.html">PTI</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_r_s232_config_html_ab938083d745d9ef0d31cb8ac653c7793"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_r_s232_config.html#ab938083d745d9ef0d31cb8ac653c7793">Apex7000_BillValidator.RS232Config.EnableMask</a></div><div class="ttdeci">byte EnableMask</div><div class="ttdoc">Bitwise enable disbale pattern. Each bit set to 1 corresponds to an enabled bill. e...</div><div class="ttdef"><b>Definition:</b> <a href="_r_s232_config_8cs_source.html#l00098">RS232Config.cs:98</a></div></div>
<div class="ttc" id="namespacelog4net_html"><div class="ttname"><a href="namespacelog4net.html">log4net</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_a2a361f835b0e31f584046ec4eb1e85e6"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#a2a361f835b0e31f584046ec4eb1e85e6">Apex7000_BillValidator.ApexValidator.Connect</a></div><div class="ttdeci">void Connect()</div><div class="ttdoc">Connect to the device and begin speaking rs232 </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00105">ApexValidator.cs:105</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_ae0f9dcdc5f6afd79e20b19828934c267"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#ae0f9dcdc5f6afd79e20b19828934c267">Apex7000_BillValidator.ApexValidator.OnCashboxAttached</a></div><div class="ttdeci">EventHandler OnCashboxAttached</div><div class="ttdoc">Raised when the cashbox is no longer detached. This only be reported if the cashbox is first attached...</div><div class="ttdef"><b>Definition:</b> <a href="_events_8cs_source.html#l00108">Events.cs:108</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_a81784448a351130d74964d5c86388c86"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#a81784448a351130d74964d5c86388c86">Apex7000_BillValidator.ApexValidator.PreviousEvents</a></div><div class="ttdeci">Events PreviousEvents</div><div class="ttdoc">Slave&#39;s last events </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00060">ApexValidator.cs:60</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_r_s232_config_html_a9754bded053ecdce67bcd8c58bfd79c4"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_r_s232_config.html#a9754bded053ecdce67bcd8c58bfd79c4">Apex7000_BillValidator.RS232Config.IsEscrowMode</a></div><div class="ttdeci">bool IsEscrowMode</div><div class="ttdoc">Escrow mode allows you to manually call Stack() or Reject() on each escrowed note. If false, we stack any valid note automatically. </div><div class="ttdef"><b>Definition:</b> <a href="_r_s232_config_8cs_source.html#l00081">RS232Config.cs:81</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_a90b1a6032cffe4a13db99f27387b89e8"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#a90b1a6032cffe4a13db99f27387b89e8">Apex7000_BillValidator.ApexValidator.OnError</a></div><div class="ttdeci">EventHandler&lt; ErrorArgs &gt; OnError</div><div class="ttdoc">Raised by the master in the event that communication fails </div><div class="ttdef"><b>Definition:</b> <a href="_events_8cs_source.html#l00050">Events.cs:50</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_a71d876ee0f6ca1c8317a119ec65bc5ea"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#a71d876ee0f6ca1c8317a119ec65bc5ea">Apex7000_BillValidator.ApexValidator.GetAvailablePorts</a></div><div class="ttdeci">static List&lt; string &gt; GetAvailablePorts()</div><div class="ttdoc">Returns a list of all available ports </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00082">ApexValidator.cs:82</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_r_s232_config_html_a55d7f2d6ece5f5382379592b38532ac8"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_r_s232_config.html#a55d7f2d6ece5f5382379592b38532ac8">Apex7000_BillValidator.RS232Config.PollRate</a></div><div class="ttdeci">int PollRate</div><div class="ttdoc">Gets or sets the poll rate in milliseconds. The polled system is designed for the master to request i...</div><div class="ttdef"><b>Definition:</b> <a href="_r_s232_config_8cs_source.html#l00054">RS232Config.cs:54</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_r_s232_config_html"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_r_s232_config.html">Apex7000_BillValidator.RS232Config</a></div><div class="ttdoc">Define the operating parameters of your bill acceptor </div><div class="ttdef"><b>Definition:</b> <a href="_r_s232_config_8cs_source.html#l00008">RS232Config.cs:8</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_abf1ccb34c3402102da76f9410e0215db"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#abf1ccb34c3402102da76f9410e0215db">Apex7000_BillValidator.ApexValidator.RequestReset</a></div><div class="ttdeci">void RequestReset()</div><div class="ttdoc">Sets flag to reset the acceptor on the next message sent </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00159">ApexValidator.cs:159</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html_a0e3003b4ad602a0ab34aa728aa1f9de7"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html#a0e3003b4ad602a0ab34aa728aa1f9de7">Apex7000_BillValidator.ApexValidator.ApexValidator</a></div><div class="ttdeci">ApexValidator(RS232Config config)</div><div class="ttdoc">Creates a new ApexValidator using the specified configuration </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00072">ApexValidator.cs:72</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_debug_buffer_entry_html"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_debug_buffer_entry.html">Apex7000_BillValidator.DebugBufferEntry</a></div><div class="ttdoc">Helper entry for describing serial communication transactions </div><div class="ttdef"><b>Definition:</b> <a href="_debug_buffer_8cs_source.html#l00009">DebugBuffer.cs:9</a></div></div>
<div class="ttc" id="namespace_p_t_i_1_1_serial_html"><div class="ttname"><a href="namespace_p_t_i_1_1_serial.html">PTI.Serial</a></div><div class="ttdef"><b>Definition:</b> <a href="_i_comm_port_8cs_source.html#l00016">ICommPort.cs:16</a></div></div>
<div class="ttc" id="namespace_apex7000___bill_validator_html"><div class="ttname"><a href="namespace_apex7000___bill_validator.html">Apex7000_BillValidator</a></div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00008">ApexValidator.cs:8</a></div></div>
<div class="ttc" id="class_apex7000___bill_validator_1_1_apex_validator_html"><div class="ttname"><a href="class_apex7000___bill_validator_1_1_apex_validator.html">Apex7000_BillValidator.ApexValidator</a></div><div class="ttdoc">The main class that does the actual "talking" the acceptor. In the context of documentation, this object what is referred to as the master and the acceptor is the slave device. </div><div class="ttdef"><b>Definition:</b> <a href="_apex_validator_8cs_source.html#l00014">ApexValidator.cs:14</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_203afc9443b0f768909bae0ea35d1540.html">Apex7000_BillValidator</a></li><li class="navelem"><b>ApexValidator.cs</b></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
